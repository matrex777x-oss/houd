<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Attendance Processor (Offline)</title>
  <style>
/* style.css (V5) â€” Modern + print controls */
:root{
  --bg0:#070b14; --bg1:#0b1220;
  --panel: rgba(17,26,46,.82);
  --panel2: rgba(255,255,255,.04);
  --text:#eaf1ff;
  --muted:#a7b7d6;
  --accent:#4da3ff;
  --accent2:#8b5cff;
  --danger:#ff5a6a;
  --border: rgba(255,255,255,.10);
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  --radius: 16px;
  --shadow: 0 14px 50px rgba(0,0,0,.35);
}
body{
  margin:0; font-family:var(--sans);
  background:
    radial-gradient(900px 500px at 90% 0%, rgba(77,163,255,.18), transparent 60%),
    radial-gradient(800px 500px at 10% 0%, rgba(139,92,255,.16), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg0));
  color:var(--text);
}
body[data-theme="light"]{
  --bg0:#f5f7fb; --bg1:#ffffff;
  --panel: rgba(255,255,255,.92);
  --panel2: rgba(0,0,0,.04);
  --text:#0b1220;
  --muted:#52637d;
  --border: rgba(0,0,0,.10);
  --shadow: 0 12px 40px rgba(20,30,60,.12);
}
.topbar{
  padding:14px 16px; position:sticky; top:0; z-index:5;
  background: linear-gradient(180deg, rgba(17,26,46,.70), rgba(17,26,46,.35));
  border-bottom: 1px solid var(--border);
  backdrop-filter: blur(12px);
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}
body[data-theme="light"] .topbar{
  background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.55));
}
.brand{ display:flex; align-items:center; gap:12px; }
.logo{
  width:40px; height:40px; border-radius:14px; display:grid; place-items:center;
  background: linear-gradient(135deg, rgba(77,163,255,.35), rgba(139,92,255,.25));
  border:1px solid var(--border);
  box-shadow: var(--shadow);
}
.topbar h1{ margin:0; font-size:16px; }
.sub{ margin-top:2px; font-size:12px; color:var(--muted); }
.topActions{ display:flex; gap:8px; align-items:center; }
main{ padding:16px; max-width:1280px; margin:0 auto; }
.layout{ display:grid; grid-template-columns: 1.05fr .95fr; gap:12px; align-items:start; }
@media (max-width: 980px){ .layout{ grid-template-columns:1fr; } }

.card{
  background: var(--panel);
  border:1px solid var(--border);
  border-radius: var(--radius);
  padding:14px;
  box-shadow: var(--shadow);
}
.cardHead{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px; }
.cardTitle{ font-size:13px; font-weight:900; }
.cardSub{ font-size:12px; color:var(--muted); margin-top:2px; }
.cardHeadActions{ display:flex; gap:8px; flex-wrap:wrap; }

textarea{
  width:100%; min-height:230px; resize:vertical;
  font-family:var(--mono); font-size:12px;
  padding:12px; border-radius:14px; border:1px solid var(--border);
  background: rgba(11,16,32,.85);
  color:var(--text);
  outline:none;
}
body[data-theme="light"] textarea{ background: rgba(250,251,255,.95); }

.controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
.filters{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }

.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.pushLeft{ margin-inline-start:auto; }

button{
  border:1px solid var(--border);
  background: rgba(77,163,255,.14);
  color:var(--text);
  padding:10px 12px;
  border-radius: 14px;
  cursor:pointer;
  font-weight:800;
  transition: transform .05s ease, background .2s ease, border-color .2s ease;
}
button:hover{ background: rgba(77,163,255,.18); }
button:active{ transform: translateY(1px); }
button.primary{ background: rgba(77,163,255,.24); border-color: rgba(77,163,255,.40); }
button.danger{ background: rgba(255,90,106,.16); border-color: rgba(255,90,106,.40); }
button.ghost{ background: var(--panel2); }
button.ghost:hover{ background: rgba(255,255,255,.07); }
body[data-theme="light"] button.ghost:hover{ background: rgba(0,0,0,.05); }

.pill{
  display:inline-flex; gap:8px; align-items:center;
  padding:8px 10px; border-radius: 999px;
  border:1px solid var(--border);
  background: var(--panel2);
  font-size:12px; color:var(--muted);
}
select, input{
  background: rgba(11,16,32,.85);
  color:var(--text);
  border:1px solid var(--border);
  border-radius: 12px;
  padding:8px 10px;
  outline:none;
}
body[data-theme="light"] select, body[data-theme="light"] input{ background: rgba(250,251,255,.98); }
.pill input{ width:76px; }

.status{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.6; }
.status .err{ color:var(--danger); font-weight:900; }

.tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
.tab{
  padding:9px 12px; border-radius:999px;
  border:1px solid var(--border);
  background: var(--panel2);
  cursor:pointer; font-size:12px; font-weight:800;
}
.tab.active{
  border-color: rgba(77,163,255,.55);
  background: rgba(77,163,255,.16);
}

.tablewrap{
  overflow:auto; border-radius:14px; border:1px solid var(--border);
  margin-top:12px;
}
table{ width:100%; border-collapse:collapse; font-size:12px; min-width:980px; }
th, td{ padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.06); text-align:right; white-space:nowrap; }
body[data-theme="light"] th, body[data-theme="light"] td{ border-bottom:1px solid rgba(0,0,0,.06); }
th{ position:sticky; top:0; background: rgba(13,22,48,.95); z-index:1; }
body[data-theme="light"] th{ background: rgba(245,247,251,.98); }
tr:hover td{ background: rgba(255,255,255,.04); }
body[data-theme="light"] tr:hover td{ background: rgba(0,0,0,.03); }

.totalRow td{ background: rgba(255,255,255,.06); font-weight: 900; border-top: 2px solid rgba(255,255,255,.18); }
body[data-theme="light"] .totalRow td{ background: rgba(0,0,0,.05); border-top:2px solid rgba(0,0,0,.15); }
.absentRow td{ background: rgba(255,90,106,.10); }
.irregularRow td{ background: rgba(255,255,255,.05); border-top: 1px dashed rgba(255,255,255,.18); }
body[data-theme="light"] .irregularRow td{ background: rgba(0,0,0,.04); border-top: 1px dashed rgba(0,0,0,.18); }

.actualCell{
  font-weight: 1000;
  background: rgba(77,163,255,.10);
  border-left: 2px solid rgba(77,163,255,.35);
  border-right: 2px solid rgba(77,163,255,.35);
}

.kpi{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:10px; }
.kpi3{ grid-template-columns: repeat(3, 1fr); }
@media (max-width: 980px){ .kpi{ grid-template-columns: repeat(2, 1fr); } .kpi3{ grid-template-columns:1fr; } }
.k{ background: var(--panel2); border:1px solid var(--border); border-radius: 16px; padding:10px; }
.k .n{ font-size:18px; font-weight:1000; margin-top:6px;}
.k .l{ color:var(--muted); font-size:12px;}
.hint{ color:var(--muted); font-size:12px; margin-top:8px; line-height:1.5; }
code{ font-family:var(--mono); font-size:12px; background: var(--panel2); padding:2px 6px; border-radius:8px; }

.drop{ margin-top:10px; border:1px solid var(--border); border-radius: 16px; background: var(--panel2); overflow:hidden; }
.drop summary{ cursor:pointer; padding:10px 12px; font-weight:1000; list-style:none; }
.drop summary::-webkit-details-marker { display:none; }
.dropBody{ padding:12px; border-top:1px solid rgba(255,255,255,.08); }
body[data-theme="light"] .dropBody{ border-top:1px solid rgba(0,0,0,.08); }

.formGrid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
.formGrid3 label{ color:var(--muted); font-size:12px; }
.formGrid3 input, .formGrid3 select{ width:100%; box-sizing:border-box; margin-top:6px; }
@media (max-width: 980px){ .formGrid3{ grid-template-columns:1fr; } }

.scheduleWrap table{ min-width:1200px; }
.scheduleWrap input{ width:90px; }
.scheduleWrap .dayCell{ text-align:center; }
.scheduleWrap .dayCell input{ width:auto; }

/* ===== PRINT ===== */
.printOnly{ display:none; }
body.printing{ background:#fff !important; color:#000 !important; }
body.printing .noPrint{ display:none !important; }
body.printing .printOnly{ display:block !important; background:#fff !important; color:#000 !important; border:1px solid #ddd; border-radius:12px; padding:12px; margin-bottom:12px; }
body.printing .card{ background:#fff !important; border:none !important; box-shadow:none !important; padding:0 !important; }
body.printing .tablewrap{ border:1px solid #ddd !important; }
body.printing table{ min-width:0 !important; font-size:11px !important; }
body.printing th{ position:static !important; background:#eee !important; color:#000 !important; }
body.printing td, body.printing th{ white-space:normal !important; word-break:break-word !important; }
body.printing .view{ display:none !important; }
body.printing[data-print-tab="punches"] #viewPunches{ display:block !important; }
body.printing[data-print-tab="daily"]   #viewDaily{ display:block !important; }
body.printing[data-print-tab="summary"] #viewSummary{ display:block !important; }
body.printing[data-print-tab="emp"]     #viewEmp{ display:block !important; }

/* Print fit modes */
body.printing[data-fit="compact"] table{ font-size:10px !important; }
body.printing[data-fit="wide"] table{ font-size:11px !important; }
body.printing[data-fit="wide"] th, body.printing[data-fit="wide"] td{ padding:10px 12px !important; }

/* Print header */
#printHeader .phTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
#printHeader .phCompany{ font-size:16px; font-weight:1000; }
#printHeader .phMeta{ margin-top:4px; color:#333; font-size:12px; }
#printHeader .phRight{ font-size:12px; color:#111; text-align:right; }
#printHeader .dot{ margin:0 6px; color:#999; }
#printHeader .phBottom{ margin-top:10px; display:grid; grid-template-columns: 1fr 1fr 2fr; gap:10px; font-size:12px; color:#111; }


/* Divider */
.hr{ height:1px; background: rgba(255,255,255,.10); margin:12px 0; }
body[data-theme="light"] .hr{ background: rgba(0,0,0,.10); }

/* Column picker */
.colPicker{ border:1px solid var(--border); border-radius:16px; padding:10px; background: rgba(255,255,255,.03); }
.colPickerHead{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
.colPickerTitle{ font-weight:1000; font-size:12px; color:var(--text); }
.colPickerBtns{ display:flex; gap:8px; flex-wrap:wrap; }
.colGrid{
  margin-top:10px;
  display:grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap:8px;
}
@media (max-width: 980px){ .colGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
.colItem{
  display:flex; gap:8px; align-items:center;
  border:1px solid var(--border);
  background: var(--panel2);
  border-radius: 14px;
  padding:8px 10px;
  color:var(--muted);
  font-size:12px;
}
.colItem input{ width:auto; }

/* ===== PRINT: hide selected columns by column name (data-col) ===== */
body.printing[data-hidecols~="EmployeeID"] [data-col="EmployeeID"],
body.printing[data-hidecols~="Name"]       [data-col="Name"],
body.printing[data-hidecols~="ShiftDate"]  [data-col="ShiftDate"],
body.printing[data-hidecols~="DayName"]    [data-col="DayName"],
body.printing[data-hidecols~="Status"]     [data-col="Status"],
body.printing[data-hidecols~="SchedStart"] [data-col="SchedStart"],
body.printing[data-hidecols~="SchedEnd"]   [data-col="SchedEnd"],
body.printing[data-hidecols~="ActualIn"]   [data-col="ActualIn"],
body.printing[data-hidecols~="ActualOut"]  [data-col="ActualOut"],
body.printing[data-hidecols~="WorkMinutes"] [data-col="WorkMinutes"],
body.printing[data-hidecols~="LateMinutes"] [data-col="LateMinutes"],
body.printing[data-hidecols~="OTMinutes"]   [data-col="OTMinutes"],
body.printing[data-hidecols~="Present"]     [data-col="Present"],
body.printing[data-hidecols~="Absent"]      [data-col="Absent"]{
  display:none !important;
}


/* ===== v8: Export row wrap ===== */
.toolsRow{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.toolsRow .ghost{ white-space:nowrap; }

/* ===== v8: Daily column picker (better layout) ===== */
.colPicker{ padding:14px; }
.colPickerHead{ direction: rtl; }
.colPickerTitle{ font-size:13px; }
.colGrid{ direction: rtl; grid-template-columns: repeat(3, minmax(0,1fr)); }
@media (max-width: 980px){ .colGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
@media (max-width: 520px){ .colGrid{ grid-template-columns: 1fr; } }

.colItem{ justify-content:flex-start; gap:10px; padding:10px 12px; border-radius:16px; }
.colItem input{ transform: scale(1.1); }

.colItem .colText{ display:flex; flex-direction:column; line-height:1.15; min-width:0; }
.colItem .colAr{ font-weight:900; color:var(--text); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.colItem .colEn{ font-size:11px; color:var(--muted); opacity:.9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }


/* ===== v15 Mobile-first polish ===== */
:focus-visible{ outline: 2px solid rgba(77,163,255,.65); outline-offset: 2px; }

@media (max-width: 720px){
  main{ padding:12px; }
  .topbar{ padding:12px; flex-wrap:wrap; }
  .brand h1{ font-size:15px; }
  .sub{ font-size:11px; }
  .topActions{ width:100%; justify-content:space-between; }
  .layout{ gap:10px; }

  .card{ padding:12px; }
  .cardHead{ flex-wrap:wrap; }
  .cardHeadActions{ width:100%; justify-content:flex-end; }

  textarea{ min-height:190px; font-size:12px; }
  button{ padding:12px 14px; border-radius:16px; }

  /* pills become 2-per-row */
  .controls .pill, .filters .pill{
    flex: 1 1 calc(50% - 10px);
    justify-content: space-between;
  }
  .pill input{ width:92px; }

  /* tabs become scrollable */
  .tabbar{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    padding-bottom:4px;
  }
  .tabbar::-webkit-scrollbar{ height:6px; }
  .tab{ flex:0 0 auto; }

  /* table: keep horizontal scroll but reduce min width */
  table{ min-width: 760px; }
}

@media (max-width: 520px){
  .sub{ display:none; }
  .controls .pill, .filters .pill{ flex: 1 1 100%; }
  .pill input{ width:110px; }
  table{ min-width: 700px; }
  .colGrid{ grid-template-columns: 1fr !important; }
  .colItem{ padding:10px 12px; border-radius: 16px; }
}

@media (prefers-reduced-motion: reduce){
  *{ transition:none !important; scroll-behavior:auto !important; }
}

</style>
  <!-- Dynamic @page (updated from JS for portrait/landscape) -->
  <style id="pageStyle">
    @page { size: A4 portrait; margin: 12mm; }
  </style>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="logo">â±ï¸</div>
    <div>
      <h1>Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h1>
      <div class="sub">ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª â€¢ Ù„ØµÙ‚ â†’ ØªÙ†Ø¸ÙŠÙ â†’ ØªÙ‚Ø§Ø±ÙŠØ± â†’ Ø·Ø¨Ø§Ø¹Ø©/PDF</div>
    </div>
  </div>

  <div class="topActions noPrint">
    <button id="btnTheme" class="ghost" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">ğŸŒ™</button>
    <button id="btnPrint" class="primary" title="Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF">Print / PDF</button>
  </div>
</header>

<main>
  <!-- âœ… Print header (ONLY for printing) -->
  <section id="printHeader" class="printOnly">
    <div class="phTop">
      <div>
        <div class="phCompany" id="phCompany">Attendance Report</div>
        <div class="phMeta">
          <span id="phReportTitle">â€”</span>
          <span class="dot">â€¢</span>
          <span id="phRange">â€”</span>
        </div>
      </div>
      <div class="phRight">
        <div><b>Generated:</b> <span id="phGen">â€”</span></div>
        <div><b>Employee:</b> <span id="phEmp">â€”</span></div>
      </div>
    </div>

    <div class="phBottom">
      <div><b>Prepared by:</b> <span id="phPrepared">â€”</span></div>
      <div><b>Approved by:</b> <span id="phApproved">â€”</span></div>
      <div><b>Notes:</b> <span id="phNotes">â€”</span></div>
    </div>
  </section>

  <div class="layout">
    <!-- LEFT: INPUT (hidden on print) -->
    <section class="card noPrint">
      <div class="cardHead">
        <div>
          <div class="cardTitle">1) Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
          <div class="cardSub">Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… ÙƒÙ…Ø§ Ù‡ÙŠ (TAB Ù…Ø«Ù„ Excel Ø£Ùˆ Ù…Ø³Ø§ÙØ§Øª)</div>
        </div>

        <div class="cardHeadActions">
          <button class="primary" id="btnProcess">Process</button>
          <button class="danger" id="btnClear">Clear</button>
        </div>
      </div>

      <textarea id="raw" placeholder="Ù…Ø«Ø§Ù„:
7\tareef\tNot Set1\t01/12/2025 01:04:17\t1
8\tsifat\tNot Set1\t01/12/2025 01:04:28\t1
..."></textarea>

      <div class="controls">
        <div class="pill">
          Ø³Ù…Ø§Ø­ÙŠØ© Ø§Ù„ØªØ£Ø®ÙŠØ±
          <input id="grace" type="number" min="0" step="1" value="15">
          <span>Ø¯Ù‚ÙŠÙ‚Ø©</span>
        </div>

        <div class="pill">
          Ø¨ØµÙ…Ø§Øª Ø¨Ø¹Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ ØªÙÙ†Ø³Ø¨ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª &lt;
          <input id="rollHour" type="number" min="0" max="23" step="1" value="6">
          <span>:00</span>
        </div>

        <!-- âœ… pushed far left -->
        <div class="pill pushLeft" title="Ø§Ù„Ø¨ØµÙ…Ø§Øª Ø§Ù„ØªÙŠ ØªØªÙƒØ±Ø± Ø®Ù„Ø§Ù„ Ø£Ù‚Ù„ Ù…Ù† (N) Ø«Ø§Ù†ÙŠØ© Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§">
          Ø­Ø°Ù ØªÙƒØ±Ø§Ø± Ø£Ù‚Ù„ Ù…Ù†
          <input id="dedup" type="number" min="0" step="1" value="60">
          <span>Ø«Ø§Ù†ÙŠØ©</span>
        </div>
      </div>

      <div class="hint">
        <b>Ù…Ø¯Ø¹ÙˆÙ…:</b>
        â€¢ 5 Ø£Ø¹Ù…Ø¯Ø©: <code>ID  Name  Dept  DateTime  DeviceID</code>
        â€¢ 6 Ø£Ø¹Ù…Ø¯Ø©: <code>ID  Name  Dept  Date  Time  DeviceID</code>
        â€¢ ÙŠØ¯Ø¹Ù… <code>Øµ/Ù…</code>.
      </div>

      <div class="status" id="status"></div>

      <div class="kpi" id="kpi" style="display:none;">
        <div class="k"><div class="l">Raw rows</div><div class="n" id="kRaw">0</div></div>
        <div class="k"><div class="l">After clean</div><div class="n" id="kClean">0</div></div>
        <div class="k"><div class="l">Daily rows</div><div class="n" id="kDaily">0</div></div>
        <div class="k"><div class="l">Employees</div><div class="n" id="kEmp">0</div></div>
      </div>
    </section>

    <!-- RIGHT: REPORTS -->
    <section class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">2) Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
          <div class="cardSub">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ù…ÙˆØ¸Ù Ø«Ù… Ø§Ø·Ø¨Ø¹ Ø£Ùˆ ØµØ¯Ù‘Ø± TSV Ù„ÙØªØ­Ù‡Ø§ ÙÙŠ Excel</div>
        </div>

        <div class="toolsRow">
          <button id="btnExportPunches" class="ghost">TSV Punches</button>
          <button id="btnExportDaily" class="ghost">TSV Daily</button>
          <button id="btnExportSummary" class="ghost">TSV Summary</button>
          <button id="btnXlsxSummary" class="ghost">XLSX Summary</button>
          <button id="btnXlsxDaily" class="ghost">XLSX Daily</button>
          <button id="btnXlsxPunches" class="ghost">XLSX Punches</button>
          <button id="btnXlsxEmployee" class="ghost">XLSX Employee</button>
        </div>
      </div>

      <!-- âœ… Print options -->
      <details class="drop noPrint" open>
        <summary>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© / PDF</summary>
        <div class="dropBody">
          <div class="formGrid3">
            <label>Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø©
              <select id="printOrientation">
                <option value="portrait">Ø¹Ù…ÙˆØ¯ÙŠ (Portrait)</option>
                <option value="landscape">Ø£ÙÙ‚ÙŠ (Landscape)</option>
              </select>
            </label>

            <label>Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹ØªÙ‡ØŸ
              <select id="printWhat">
                <option value="current">Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</option>
                <option value="punches">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ØµÙ…Ø§Øª (Cleaned Punches)</option>
                <option value="daily">Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ (Daily Attendance)</option>
                <option value="summary">Ù…Ù„Ø®Øµ Ø´Ù‡Ø±ÙŠ (Monthly Summary)</option>
                <option value="emp">ØªÙ‚Ø±ÙŠØ± Ù…ÙˆØ¸Ù (Employee Report)</option>
              </select>
            </label>

            <label>ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ù„Ø§Ø¡Ù…Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
              <select id="printFit">
                <option value="normal">Ø¹Ø§Ø¯ÙŠ</option>
                <option value="compact">Ù…Ø¶ØºÙˆØ· (Ø®Ø· Ø£ØµØºØ±)</option>
                <option value="wide">Ø£Ø¹Ù…Ø¯Ø© Ø£ÙˆØ³Ø¹ (Ø£ÙØ¶Ù„ Ù„Ù„Ø£ÙÙ‚ÙŠ)</option>
              </select>
            </label>
          
          <div class="hr"></div>

          <div class="hint"><b>Daily Attendance:</b> Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø®ÙØ§Ø¡Ù‡Ø§ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (ÙŠÙ†Ø·Ø¨Ù‚ Ø£ÙŠØ¶Ø§Ù‹ Ø¹Ù„Ù‰ Employee Daily).</div>

          <div class="colPicker">
            <div class="colPickerHead">
              <div class="colPickerTitle">Ø¥Ø®ÙØ§Ø¡ Ø£Ø¹Ù…Ø¯Ø© (Daily)</div>
              <div class="colPickerBtns">
                <button type="button" class="ghost" id="btnDailyMinimal">Minimal</button>
                <button type="button" class="ghost" id="btnDailyReset">Reset</button>
              </div>
            </div>

            <div class="colGrid" id="dailyColGrid">
              <!-- JS fills checkboxes -->
            </div>
          </div>
</div>

          <div class="formGrid3" style="margin-top:10px;">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©/Ø§Ù„ÙØ±Ø¹
              <input id="hdrCompany" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±ÙƒØ© ... / ÙØ±Ø¹ ..." value="Attendance Report">
            </label>
            <label>Prepared by
              <input id="hdrPrepared" placeholder="Ø§Ù„Ø§Ø³Ù…">
            </label>
            <label>Approved by
              <input id="hdrApproved" placeholder="Ø§Ù„Ø§Ø³Ù…">
            </label>
          </div>

          <div class="formGrid3" style="margin-top:10px;">
            <label style="grid-column: 1 / -1;">Notes
              <input id="hdrNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
            </label>
          </div>

          <div class="hint">
            â€¢ Ø²Ø± <b>Print / PDF</b> Ø³ÙŠÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©. Ø§Ø®ØªØ± â€œSave as PDFâ€ Ù„Ø¥Ø®Ø±Ø§Ø¬ PDF.<br>
            â€¢ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù† ÙŠØ¸Ù‡Ø± Ù‚Ø³Ù… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„Ø§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ù….
          </div>
        </div>
      </details>

      <!-- âœ… Schedule editor -->
      <details class="drop noPrint">
        <summary>ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ù… (Ù‚Ø§Ø¦Ù…Ø© ÙƒØ§Ù…Ù„Ø© Ù„ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª)</summary>
        <div class="dropBody">
          <div class="hint">
            â€¢ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ <b>Process</b> Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù…Ù† <b>1</b> Ø¥Ù„Ù‰ <b>Ø¢Ø®Ø± Ù…Ø¹Ø±Ù</b> ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.<br>
            â€¢ Ø§Ù„Ù…ÙˆØ¸Ù ID=1 ÙŠØ¹ØªØ¨Ø± <b>Manager</b> (Ù„Ø§ ØªÙØ·Ø¨Ù‚ Ø¹Ù„ÙŠÙ‡ Ø£Ø­ÙƒØ§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ±/Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ/Ø§Ù„ØºÙŠØ§Ø¨).<br>
            â€¢ Ø¥Ø°Ø§ Ø¨ØµÙ… Ø§Ù„Ù…ÙˆØ¸Ù <b>Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©</b> ÙŠØªÙ… Ø§Ø¹ØªØ¨Ø§Ø±Ù‡ Ø­Ø§Ø¶Ø± ÙˆÙ„ÙƒÙ† <b>ØºÙŠØ± Ù…Ù†ØªØ¸Ù…</b>.
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="btnApplySchedule" class="primary">Apply Schedule + Recalculate</button>
            <button id="btnExportSchedule" class="ghost">Export Schedule (TSV)</button>
            <input id="importScheduleFile" type="file" accept=".tsv,.txt,.csv" style="display:none">
            <button id="btnImportSchedule" class="ghost">Import Schedule (TSV)</button>
          </div>

          <div class="tablewrap scheduleWrap" style="margin-top:10px;">
            <table id="tblSchedule"></table>
          </div>
        </div>
      </details>

      <!-- Filters + KPIs -->
      <div class="filters noPrint">
        <div class="pill">
          ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ù‡Ø±
          <select id="monthFilter">
            <option value="ALL">ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
          </select>
        </div>

        <div class="pill">
          Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù
          <select id="employeeFilter">
            <option value="ALL">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
          </select>
        </div>

        <div class="pill bestOnly">
          Ø£ÙØ¶Ù„ Ù…ÙˆØ¸Ù: <b id="bestEmp">â€”</b>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs noPrint">
        <div class="tab active" data-tab="punches">Cleaned Punches</div>
        <div class="tab" data-tab="daily">Daily Attendance</div>
        <div class="tab" data-tab="summary">Monthly Summary</div>
        <div class="tab" data-tab="emp">Employee Report</div>
      </div>

      <!-- Views -->
      <div id="viewPunches" class="view">
        <div class="tablewrap"><table id="tblPunches"></table></div>
      </div>

      <div id="viewDaily" class="view" style="display:none;">
        <div class="tablewrap"><table id="tblDaily"></table></div>
      </div>

      <div id="viewSummary" class="view" style="display:none;">
        <div class="tablewrap"><table id="tblSummary"></table></div>
      </div>

      <div id="viewEmp" class="view" style="display:none;">
        <div class="hint noPrint">Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù Ù…Ø­Ø¯Ø¯ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</div>

        <div class="kpi" id="empKpi" style="margin-top:12px; display:none;">
          <div class="k"><div class="l">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</div><div class="n" id="eDaysP">0</div></div>
          <div class="k"><div class="l">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</div><div class="n" id="eDaysA">0</div></div>
          <div class="k"><div class="l">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªØ£Ø®ÙŠØ± (Ø¯Ù‚ÙŠÙ‚Ø©)</div><div class="n" id="eLate">0</div></div>
          <div class="k"><div class="l">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ (Ø¯Ù‚ÙŠÙ‚Ø©)</div><div class="n" id="eOT">0</div></div>
        </div>

        <div class="kpi kpi3" id="empKpi2" style="margin-top:10px; display:none;">
          <div class="k"><div class="l">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</div><div class="n" id="eWorkH">0</div></div>
          <div class="k"><div class="l">Ø£ÙˆÙ„ Ø¨ØµÙ…Ø©</div><div class="n" id="eFirst">â€”</div></div>
          <div class="k"><div class="l">Ø¢Ø®Ø± Ø¨ØµÙ…Ø©</div><div class="n" id="eLast">â€”</div></div>
        </div>

        <div class="row noPrint" style="margin-top:12px;">
          <button id="btnExportEmpDaily" class="ghost">TSV Employee Daily</button>
          <button id="btnExportEmpPunches" class="ghost">TSV Employee Punches</button>
        </div>

        <div class="hint"><b>Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù (Ù…Ø¹ ØµÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹):</b></div>
        <div class="tablewrap"><table id="tblEmpDaily"></table></div>

        <div class="hint" style="margin-top:14px"><b>Ø¨ØµÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù (Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ):</b></div>
        <div class="tablewrap"><table id="tblEmpPunches"></table></div>
      </div>

      <div class="hint noPrint">
        <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ø§Ù„ØªØµØ¯ÙŠØ± TSV (Tab) Ø­ØªÙ‰ ØªÙØªØ­ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØµØ­ÙŠØ­Ø© ÙÙŠ Excel.
      </div>
    </section>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
/* app.js (V5) â€” Modern UI + flexible print options (portrait/landscape + choose report) */
(function(){
  const $ = (id)=>document.getElementById(id);
  const dayNamesAr = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];

  function pad2(n){ return (n<10? "0":"")+n; }
  function formatDate(d){ return pad2(d.getDate()) + "/" + pad2(d.getMonth()+1) + "/" + d.getFullYear(); }
  function ymd(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
  function formatDateTime(d){ return formatDate(d)+" "+pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds()); }
  function formatTime12(d){
    let h = d.getHours(), m=d.getMinutes(), s=d.getSeconds();
    const am = h < 12;
    let h12 = h % 12; if(h12===0) h12=12;
    return pad2(h12)+":"+pad2(m)+":"+pad2(s)+" "+(am?"AM":"PM");
  }
  function minutesDiff(later, earlier){ return Math.round((later.getTime()-earlier.getTime())/60000); }
  function setStatus(msg, isErr=false){
    $("status").innerHTML = isErr ? "<span class='err'>"+msg+"</span>" : msg;
  }
  function toMidnight(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0); }
  function addDays(d, n){ const x = new Date(d.getTime()); x.setDate(x.getDate()+n); return x; }

  // ===== Parsing =====
  function parseTimeString(t){
    t = (t||"").toString().trim();
    let isPM = /Ù…/.test(t);
    let isAM = /Øµ/.test(t);
    t = t.replace(/[ØµÙ…]/g,"").trim();
    const parts = t.split(":").map(x=>x.trim()).filter(Boolean);
    if(parts.length<2) return null;
    let hh = parseInt(parts[0],10);
    let mm = parseInt(parts[1],10);
    let ss = parts.length>=3 ? parseInt(parts[2],10) : 0;
    if(Number.isNaN(hh)||Number.isNaN(mm)||Number.isNaN(ss)) return null;
    if(isPM && hh<12) hh += 12;
    if(isAM && hh===12) hh = 0;
    return {hh,mm,ss};
  }
  function parseDateString(ds){
    ds = (ds||"").toString().trim();
    const m = ds.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(!m) return null;
    return {dd:+m[1], mm:+m[2], yy:+m[3]};
  }
  function parseDateTimeFlexible(datePart, timePart){
    if(timePart==null || String(timePart).trim()===""){
      const txt = String(datePart||"").trim().replace(/\s+/g," ");
      const m = txt.match(/^(\d{1,2}\/\d{1,2}\/\d{4})\s+(.+)$/);
      if(!m) return null;
      const d = parseDateString(m[1]); if(!d) return null;
      const t = parseTimeString(m[2]); if(!t) return null;
      return new Date(d.yy, d.mm-1, d.dd, t.hh, t.mm, t.ss, 0);
    } else {
      const d = parseDateString(String(datePart||"").trim()); if(!d) return null;
      const t = parseTimeString(String(timePart||"").trim()); if(!t) return null;
      return new Date(d.yy, d.mm-1, d.dd, t.hh, t.mm, t.ss, 0);
    }
  }
  function parseRaw(text){
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const out = [];
    for(const line of lines){
      let parts = line.split("\t").map(x=>x.trim()).filter(Boolean);
      if(parts.length < 5) parts = line.split(/\s{2,}/).map(x=>x.trim()).filter(Boolean);
      if(parts.length < 5) continue;
      let empId, name, dept, datePart, timePart, deviceId;
      if(parts.length >= 6){
        empId = parseInt(parts[0],10);
        name = parts[1]||""; dept = parts[2]||"";
        datePart = parts[3]||""; timePart = parts[4]||"";
        deviceId = parts[5]||"";
      } else {
        empId = parseInt(parts[0],10);
        name = parts[1]||""; dept = parts[2]||"";
        datePart = parts[3]||""; timePart = "";
        deviceId = parts[4]||"";
      }
      if(!Number.isFinite(empId)) continue;
      const dt = parseDateTimeFlexible(datePart, timePart);
      if(!dt || isNaN(dt.getTime())) continue;
      out.push({empId, name, dept, deviceId, dateTime: dt});
    }
    return out;
  }
  function dedupPunches(punches, dedupSeconds){
    punches.sort((a,b)=> a.empId-b.empId || a.dateTime-b.dateTime);
    const out = [];
    const lastByEmp = new Map();
    for(const p of punches){
      const last = lastByEmp.get(p.empId);
      if(last){
        const diff = (p.dateTime.getTime()-last.dateTime.getTime())/1000;
        if(diff >= 0 && diff < dedupSeconds) continue;
      }
      out.push(p);
      lastByEmp.set(p.empId, p);
    }
    return out;
  }
  function computeShiftDate(dt, rollHour){
    const mid = toMidnight(dt);
    const threshold = new Date(mid.getTime());
    threshold.setHours(rollHour,0,0,0);
    if(dt < threshold){
      const prev = new Date(mid.getTime());
      prev.setDate(prev.getDate()-1);
      return prev;
    }
    return mid;
  }

  // ===== Schedule =====
  const schedule = {};
  function parseHHMM(s){
    const m = String(s||"").trim().match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return null;
    const hh = +m[1], mm = +m[2];
    if(hh<0||hh>23||mm<0||mm>59) return null;
    return {hh,mm};
  }
  function hhmmOk(v){ return /^\d{1,2}:\d{2}$/.test(String(v||"")) && parseHHMM(v) !== null; }
  function defaultScheduleFor(empId){
    const isManager = (empId===1);
    const workAll = [true,true,true,true,true,true,true];
    if(empId===3 || empId===4){
      return {isManager, weekdayStart:"16:00", weekdayEnd:"01:00", weekendStart:"16:00", weekendEnd:"01:00", workDays:workAll};
    }
    if(empId===7){
      return {isManager, weekdayStart:"05:00", weekdayEnd:"16:00", weekendStart:"12:00", weekendEnd:"16:00", workDays:workAll};
    }
    return {isManager, weekdayStart:"14:30", weekdayEnd:"01:00", weekendStart:"14:30", weekendEnd:"01:00", workDays:workAll};
  }
  function ensureScheduleRows(employeeMap, maxId){
    for(let id=1; id<=maxId; id++){
      if(!schedule[id]){
        schedule[id] = { name: employeeMap.get(id) || "", ...defaultScheduleFor(id) };
      } else {
        schedule[id].name = schedule[id].name || employeeMap.get(id) || "";
        const def = defaultScheduleFor(id);
        schedule[id].isManager = (schedule[id].isManager ?? def.isManager);
        schedule[id].weekdayStart = schedule[id].weekdayStart || def.weekdayStart;
        schedule[id].weekdayEnd = schedule[id].weekdayEnd || def.weekdayEnd;
        schedule[id].weekendStart = schedule[id].weekendStart || def.weekendStart;
        schedule[id].weekendEnd = schedule[id].weekendEnd || def.weekendEnd;
        schedule[id].workDays = schedule[id].workDays || def.workDays;
      }
    }
  }
  function renderScheduleTable(maxId){
    const tbl = $("tblSchedule");
    const cols = ["EmployeeID","Name","Manager?","Weekday Start","Weekday End","Weekend Start","Weekend End","Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    tbl.innerHTML = "";
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    for(const c of cols){ const th=document.createElement("th"); th.textContent=c; th.dataset.col=c; trh.appendChild(th); }
    thead.appendChild(trh); tbl.appendChild(thead);

    const tbody = document.createElement("tbody");
    for(let id=1; id<=maxId; id++){
      const s = schedule[id];
      const tr = document.createElement("tr");

      const tdId = document.createElement("td"); tdId.textContent=String(id); tr.appendChild(tdId);

      const tdName = document.createElement("td");
      const inName = document.createElement("input");
      inName.value = s.name || ""; inName.placeholder="name";
      inName.addEventListener("input", ()=>{ schedule[id].name = inName.value; });
      tdName.appendChild(inName); tr.appendChild(tdName);

      const tdMgr = document.createElement("td"); tdMgr.className="dayCell";
      const ckMgr = document.createElement("input"); ckMgr.type="checkbox"; ckMgr.checked=!!s.isManager;
      ckMgr.addEventListener("change", ()=>{ schedule[id].isManager = ckMgr.checked; });
      tdMgr.appendChild(ckMgr); tr.appendChild(tdMgr);

      tr.appendChild(tdTimeInput(id,"weekdayStart"));
      tr.appendChild(tdTimeInput(id,"weekdayEnd"));
      tr.appendChild(tdTimeInput(id,"weekendStart"));
      tr.appendChild(tdTimeInput(id,"weekendEnd"));

      for(let d=0; d<7; d++){
        const td = document.createElement("td"); td.className="dayCell";
        const ck = document.createElement("input"); ck.type="checkbox"; ck.checked=!!s.workDays[d];
        ck.addEventListener("change", ()=>{ schedule[id].workDays[d]=ck.checked; });
        td.appendChild(ck); tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    tbl.appendChild(tbody);

    function tdTimeInput(empId, field){
      const td = document.createElement("td");
      const inp = document.createElement("input");
      inp.value = schedule[empId][field]; inp.placeholder="HH:MM";
      inp.addEventListener("input", ()=>{ schedule[empId][field] = inp.value.trim(); });
      td.appendChild(inp); return td;
    }
  }
  function readScheduleFromUI(maxId){
    for(let id=1; id<=maxId; id++){
      const s = schedule[id];
      for(const f of ["weekdayStart","weekdayEnd","weekendStart","weekendEnd"]){
        if(!hhmmOk(s[f])){
          alert(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ§Ù…: EmployeeID=${id} field=${f} value=${s[f]}\nØ§ÙƒØªØ¨ HH:MM Ù…Ø«Ù„ 14:30`);
          return false;
        }
      }
      if(!Array.isArray(s.workDays) || s.workDays.length!==7) s.workDays=[true,true,true,true,true,true,true];
    }
    return true;
  }
  function scheduleForDate(empId, shiftDate){
    const s = schedule[empId] || defaultScheduleFor(empId);
    const wd = shiftDate.getDay();
    const isWeekend = (wd===5 || wd===6);
    const startStr = isWeekend ? s.weekendStart : s.weekdayStart;
    const endStr   = isWeekend ? s.weekendEnd   : s.weekdayEnd;
    const st = parseHHMM(startStr), en = parseHHMM(endStr);
    if(!st || !en) return null;

    const start = new Date(shiftDate.getFullYear(), shiftDate.getMonth(), shiftDate.getDate(), st.hh, st.mm, 0, 0);
    let end = new Date(shiftDate.getFullYear(), shiftDate.getMonth(), shiftDate.getDate(), en.hh, en.mm, 0, 0);
    if(end <= start) end.setDate(end.getDate()+1);

    return {start, end, isWorkday: !!(s.workDays && s.workDays[wd]), isManager: !!s.isManager};
  }

  // ===== Build outputs =====
  function buildPunchRows(clean, rollHour){
    return clean.map(p=>{
      const sd = computeShiftDate(p.dateTime, rollHour);
      return {
        EmployeeID: p.empId,
        Name: p.name,
        Dept: p.dept,
        DeviceID: p.deviceId,
        DateTime: formatDateTime(p.dateTime),
        ShiftDate: formatDate(sd),
        DayName: dayNamesAr[sd.getDay()],
        Time12h: formatTime12(p.dateTime)
      };
    });
  }

  function buildDailyWithAbsences(clean, rollHour, graceMin, monthVal, maxId){
    const groups = new Map();
    let minSD=null, maxSD=null;

    for(const p of clean){
      const sd = computeShiftDate(p.dateTime, rollHour);
      if(!minSD || sd < minSD) minSD = sd;
      if(!maxSD || sd > maxSD) maxSD = sd;

      const key = p.empId + "|" + ymd(sd);
      let g = groups.get(key);
      if(!g){ g = {empId:p.empId, name:p.name, shiftDate:sd, punches:[]}; groups.set(key,g); }
      g.punches.push(p.dateTime);
      if(!g.name && p.name) g.name=p.name;
    }
    if(!minSD || !maxSD) return [];

    let rangeStart = toMidnight(minSD);
    let rangeEnd = toMidnight(maxSD);
    if(monthVal !== "ALL"){
      const [yyyy, mm] = monthVal.split("-").map(x=>parseInt(x,10));
      rangeStart = new Date(yyyy, mm-1, 1, 0,0,0,0);
      rangeEnd = new Date(yyyy, mm, 0, 0,0,0,0);
    }

    const daily = [];
    const presentSet = new Set();

    // present/irregular days
    for(const g of groups.values()){
      const key = g.empId + "|" + ymd(g.shiftDate);
      presentSet.add(key);

      if(monthVal !== "ALL"){
        const [yyyy, mm] = monthVal.split("-").map(x=>parseInt(x,10));
        if(g.shiftDate.getFullYear() !== yyyy || (g.shiftDate.getMonth()+1) !== mm) continue;
      }

      g.punches.sort((a,b)=>a-b);
      const sched = scheduleForDate(g.empId, g.shiftDate);
      if(!sched) continue;

      const {start, end, isManager} = sched;
      const punchCount = g.punches.length;
      const actualIn = g.punches[0];
      const actualOutRaw = g.punches[punchCount-1];
      const status = (punchCount===1) ? "IRREGULAR" : "REGULAR";

      let actualOut = actualOutRaw;
      if(actualOut < actualIn){ actualOut = new Date(actualOut.getTime()); actualOut.setDate(actualOut.getDate()+1); }
      const workMin = (punchCount===1) ? 0 : Math.max(0, minutesDiff(actualOut, actualIn));

      let lateMin = 0;
      if(!isManager){
        const rawLate = Math.max(0, minutesDiff(actualIn, start));
        lateMin = Math.max(0, rawLate - graceMin);
      }

      let otMin = 0;
      if(!isManager && punchCount>1){
        let outForOt = actualOutRaw;
        if(outForOt < start){ outForOt = new Date(outForOt.getTime()); outForOt.setDate(outForOt.getDate()+1); }
        otMin = Math.max(0, minutesDiff(outForOt, end));
      }

      daily.push({
        __rowType: status,
        EmployeeID: g.empId,
        Name: schedule[g.empId]?.name || g.name || "",
        ShiftDate: formatDate(g.shiftDate),
        DayName: dayNamesAr[g.shiftDate.getDay()],
        Status: status,
        SchedStart: formatTime12(start),
        SchedEnd: formatTime12(end),
        ActualIn: formatTime12(actualIn),
        ActualOut: (punchCount===1 ? "â€”" : formatTime12(actualOutRaw)),
        WorkMinutes: workMin,
        LateMinutes: lateMin,
        OTMinutes: otMin,
        Present: (isManager ? "" : "YES"),
        Absent: (isManager ? "" : "NO")
      });
    }

    // absences based on schedule days
    for(let empId=1; empId<=maxId; empId++){
      const s = schedule[empId] || defaultScheduleFor(empId);
      if(s.isManager) continue;
      for(let d = new Date(rangeStart.getTime()); d <= rangeEnd; d = addDays(d,1)){
        const sd = toMidnight(d);
        const sch = scheduleForDate(empId, sd);
        if(!sch || !sch.isWorkday) continue;
        const key = empId + "|" + ymd(sd);
        if(presentSet.has(key)) continue;

        daily.push({
          __rowType: "ABSENT",
          EmployeeID: empId,
          Name: s.name || "",
          ShiftDate: formatDate(sd),
          DayName: dayNamesAr[sd.getDay()],
          Status: "ABSENT",
          SchedStart: formatTime12(sch.start),
          SchedEnd: formatTime12(sch.end),
          ActualIn: "â€”",
          ActualOut: "â€”",
          WorkMinutes: 0,
          LateMinutes: 0,
          OTMinutes: 0,
          Present: "NO",
          Absent: "YES"
        });
      }
    }

    daily.sort((a,b)=>{
      const aId = (a.EmployeeID==="TOTAL"? 1e9 : +a.EmployeeID);
      const bId = (b.EmployeeID==="TOTAL"? 1e9 : +b.EmployeeID);
      if(aId!==bId) return aId-bId;
      return a.ShiftDate.localeCompare(b.ShiftDate);
    });
    return daily;
  }

  function buildSummary(daily){
    const byEmp = new Map();
    for(const r of daily){
      if(r.EmployeeID === "TOTAL") continue;
      const empId = +r.EmployeeID;
      const isManager = !!(schedule[empId]?.isManager);
      let s = byEmp.get(empId);
      if(!s){
        s = {EmployeeID: empId, Name: schedule[empId]?.name || r.Name || "",
             DaysPresent:0, DaysAbsent:0, IrregularDays:0, TotalLateMin:0, TotalOTMin:0, TotalWorkHours:0};
        byEmp.set(empId,s);
      }
      if(isManager) continue;
      if(r.Present==="YES") s.DaysPresent++;
      if(r.Absent==="YES") s.DaysAbsent++;
      if(r.Status==="IRREGULAR") s.IrregularDays++;
      s.TotalLateMin += (+r.LateMinutes||0);
      s.TotalOTMin += (+r.OTMinutes||0);
      s.TotalWorkHours += (+r.WorkMinutes||0)/60;
    }
    const out = Array.from(byEmp.values()).sort((a,b)=>a.EmployeeID-b.EmployeeID);
    for(const x of out) x.TotalWorkHours = Math.round(x.TotalWorkHours*100)/100;
    return out;
  }

  // Totals rows
  function addTotalsRowDaily(rows){
    if(!rows || rows.length===0) return rows;
    let work=0, late=0, ot=0, present=0, absent=0, irregular=0;
    for(const r of rows){
      work += (+r.WorkMinutes||0);
      late += (+r.LateMinutes||0);
      ot += (+r.OTMinutes||0);
      if(r.Present==="YES") present++;
      if(r.Absent==="YES") absent++;
      if(r.Status==="IRREGULAR") irregular++;
    }
    const total = {};
    Object.keys(rows[0]).forEach(k=> total[k]="");
    total.__rowType = "TOTAL";
    total.EmployeeID = "TOTAL";
    total.Name = "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹";
    total.Status = `Present=${present}, Absent=${absent}, Irregular=${irregular}`;
    total.WorkMinutes = work; total.LateMinutes = late; total.OTMinutes = ot;
    return rows.concat([total]);
  }
  function addTotalsRowSummary(rows){
    // Totals row in Monthly Summary: only aggregate meaningful totals across employees.
    // We keep: TotalWorkHours + TotalOTMin. Other "totals" are intentionally blank.
    if(!rows || rows.length===0) return rows;

    let ot=0, wh=0;
    for(const r of rows){
      ot += (+r.TotalOTMin||0);
      wh += (+r.TotalWorkHours||0);
    }

    const total = {};
    Object.keys(rows[0]).forEach(k=> total[k]="");
    total.__rowType = "TOTAL";
    total.EmployeeID = "TOTAL";
    total.Name = "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹";
    if("TotalWorkHours" in total) total.TotalWorkHours = Math.round(wh*100)/100;
    if("TotalOTMin" in total) total.TotalOTMin = Math.round(ot);

    return rows.concat([total]);
  }

  function renderTable(tbl, rows){
    tbl.innerHTML = "";
    if(!rows || rows.length===0){
      tbl.innerHTML = "<tr><td style='padding:14px;color:#9fb0d0'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>";
      return;
    }
    const cols = Object.keys(rows[0]).filter(c=>c!=="__rowType");
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    for(const c of cols){ const th=document.createElement("th"); th.textContent=c; th.dataset.col=c; trh.appendChild(th); }
    thead.appendChild(trh); tbl.appendChild(thead);

    const tbody = document.createElement("tbody");
    for(const r of rows){
      const tr = document.createElement("tr");
      if(r.__rowType==="TOTAL") tr.classList.add("totalRow");
      if(r.__rowType==="ABSENT") tr.classList.add("absentRow");
      if(r.__rowType==="IRREGULAR") tr.classList.add("irregularRow");

      for(const c of cols){
        const td = document.createElement("td");
        td.dataset.col = c;
        td.textContent = (r[c]===null||r[c]===undefined) ? "" : String(r[c]);
        if(c==="ActualIn" || c==="ActualOut") td.classList.add("actualCell");
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    tbl.appendChild(tbody);
  }

  // TSV export
  function downloadTSV(filename, rows){
    if(!rows || rows.length===0){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±."); return; }
    const cols = Object.keys(rows[0]).filter(c=>c!=="__rowType");
    const esc = (v)=>{ v=(v===null||v===undefined)?"":String(v); return v.replace(/\t/g," ").replace(/\r?\n/g," "); };
    const tsv = [cols.map(esc).join("\t")].concat(rows.map(r=>cols.map(c=>esc(r[c])).join("\t"))).join("\n");
    const blob = new Blob([tsv], {type:"text/tab-separated-values;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  // ===== XLSX export (Excel) =====
  // Uses SheetJS (xlsx) loaded from CDN in index.html.
  // If you are offline and XLSX is not loaded, you can still use TSV (Excel can open it).
  function ensureXLSX(){
    if(typeof XLSX === "undefined"){
      alert("XLSX library not loaded.\n- Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ø§ØªØµØ§Ù„ Ø§Ù†ØªØ±Ù†Øª (Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©)\n- Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… TSV (ÙŠÙØªØ­ ÙÙŠ Excel).");
      return false;
    }
    return true;
  }

  function exportRowsToXLSX(rows, sheetName, fileName){
    if(!ensureXLSX()) return;
    if(!rows || rows.length===0){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±."); return; }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, sheetName || "Sheet1");
    XLSX.writeFile(wb, fileName || "attendance.xlsx");
  }

  function exportDatasetXLSX(kind){
    // kind: "summary" | "daily" | "punches" | "employee"
    if(kind==="summary") return exportRowsToXLSX(addTotalsRowSummary(state.summary || []), "MonthlySummary", "Monthly_Summary.xlsx");
    if(kind==="daily")   return exportRowsToXLSX(addTotalsRowDaily(state.dailyFiltered || []), "DailyAttendance", "Daily_Attendance.xlsx");
    if(kind==="punches") return exportRowsToXLSX(state.punchesFiltered || [], "Punches", "Punches.xlsx");
    if(kind==="employee"){
      const empId = $("empSelect")?.value;
      const empName = (state.employeeMap?.get(String(empId))?.name) || "Employee";
      const rows = addTotalsRowDaily(state.empDailyRows || []);
      const safe = `Employee_${empId}_${empName}.xlsx`.replace(/[\\/:*?"<>|]/g,"_");
      return exportRowsToXLSX(rows, "EmployeeReport", safe);
    }
  }


  // Filters utils
  function computeMonthsFromDaily(daily){
    const set = new Map();
    for(const r of daily){
      const parts = r.ShiftDate.split("/");
      const key = parts[2]+"-"+parts[1];
      if(!set.has(key)) set.set(key, {key, label: parts[1]+"/"+parts[2]});
    }
    return Array.from(set.values()).sort((a,b)=>a.key.localeCompare(b.key));
  }
  function populateMonthFilter(months){
    const sel = $("monthFilter");
    const current = sel.value;
    sel.innerHTML = '<option value="ALL">ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>';
    for(const m of months){ const opt=document.createElement("option"); opt.value=m.key; opt.textContent=m.label; sel.appendChild(opt); }
    sel.value = (current && Array.from(sel.options).some(o=>o.value===current)) ? current : "ALL";
  }
  function buildEmployeeNameMap(raw){
    const m = new Map();
    for(const p of raw){
      if(!m.has(p.empId)) m.set(p.empId, p.name || "");
      else if(!m.get(p.empId) && p.name) m.set(p.empId, p.name);
    }
    return m;
  }
  function populateEmployeeFilter(maxId){
    const sel = $("employeeFilter");
    const current = sel.value;
    sel.innerHTML = '<option value="ALL">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>';
    for(let id=1; id<=maxId; id++){
      const opt=document.createElement("option");
      opt.value=String(id);
      const nm=schedule[id]?.name||"";
      opt.textContent=id + (nm?(" - "+nm):"");
      sel.appendChild(opt);
    }
    sel.value = (current && Array.from(sel.options).some(o=>o.value===current)) ? current : "ALL";
  }
  function computeBest(summaryRows){
    if(!summaryRows || summaryRows.length===0) return "â€”";
    const scored = summaryRows
      .filter(r => r.EmployeeID!=="TOTAL" && !schedule[r.EmployeeID]?.isManager)
      .map(r=>{
        const score = (r.DaysPresent*10) - (r.DaysAbsent*20) - ((r.TotalLateMin||0)/10) - ((r.IrregularDays||0)*2);
        return {id:r.EmployeeID, name:r.Name||"", score};
      });
    if(scored.length===0) return "â€”";
    scored.sort((a,b)=>b.score-a.score);
    return `${scored[0].id} - ${scored[0].name}`;
  }

  // Employee report
  function renderEmployeeReport(){
    const empVal = $("employeeFilter").value;
    const monthVal = $("monthFilter").value;
    const kpi1=$("empKpi"), kpi2=$("empKpi2");

    if(empVal==="ALL"){
      kpi1.style.display="none"; kpi2.style.display="none";
      renderTable($("tblEmpDaily"), []);
      renderTable($("tblEmpPunches"), []);
      return;
    }
    const empId = parseInt(empVal,10);
    const dailyAll = state.dailyFiltered.filter(r => r.EmployeeID===empId);
    const punchesAll = state.punchesFiltered.filter(r => r.EmployeeID===empId);

    let daysP=0, daysA=0, late=0, ot=0, workMin=0;
    for(const r of dailyAll){
      if(r.Present==="YES") daysP++;
      if(r.Absent==="YES") daysA++;
      late += (+r.LateMinutes||0);
      ot   += (+r.OTMinutes||0);
      workMin += (+r.WorkMinutes||0);
    }
    const workH = Math.round((workMin/60)*100)/100;

    let first="â€”", last="â€”";
    if(punchesAll.length>0){
      first = punchesAll[0].DateTime + " (" + punchesAll[0].Time12h + ")";
      last  = punchesAll[punchesAll.length-1].DateTime + " (" + punchesAll[punchesAll.length-1].Time12h + ")";
    }

    $("eDaysP").textContent=daysP;
    $("eDaysA").textContent=daysA;
    $("eLate").textContent=late;
    $("eOT").textContent=ot;
    $("eWorkH").textContent=workH;
    $("eFirst").textContent=first;
    $("eLast").textContent=last;
    kpi1.style.display=""; kpi2.style.display="";

    renderTable($("tblEmpDaily"), addTotalsRowDaily(dailyAll));
    renderTable($("tblEmpPunches"), punchesAll);

    $("btnExportEmpDaily").onclick = ()=> downloadTSV(`employee_${empId}_daily_${monthVal==="ALL"?"all":monthVal}.tsv`, addTotalsRowDaily(dailyAll));
    $("btnExportEmpPunches").onclick = ()=> downloadTSV(`employee_${empId}_punches_${monthVal==="ALL"?"all":monthVal}.tsv`, punchesAll);
  }

  // Tabs
  function setActiveTab(tabName){
    state.activeTab = tabName;
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".view").forEach(v=>v.style.display="none");
    document.querySelector(`.tab[data-tab="${tabName}"]`)?.classList.add("active");
    $("viewPunches").style.display = (tabName==="punches") ? "" : "none";
    $("viewDaily").style.display   = (tabName==="daily") ? "" : "none";
    $("viewSummary").style.display = (tabName==="summary") ? "" : "none";
    $("viewEmp").style.display     = (tabName==="emp") ? "" : "none";
    if(tabName==="emp") renderEmployeeReport();
  }
  document.querySelectorAll(".tab").forEach(t=> t.addEventListener("click", ()=> setActiveTab(t.getAttribute("data-tab"))) );

  // ===== Printing / PDF =====
  function nowString(){ const d=new Date(); return `${formatDate(d)} ${formatTime12(d)}`; }
  function currentRangeText(){ const m=$("monthFilter").value; if(m==="ALL") return "All months"; const [yyyy,mm]=m.split("-"); return `${mm}/${yyyy}`; }
  function tabTitle(tab){ return tab==="daily"?"Daily Attendance":tab==="summary"?"Monthly Summary":tab==="emp"?"Employee Report":"Cleaned Punches"; }
  function currentEmpText(){ const v=$("employeeFilter").value; if(v==="ALL") return "â€”"; const id=parseInt(v,10); const nm=schedule[id]?.name||""; return nm?`${id} - ${nm}`:String(id); }

  function fillPrintHeader(printTab){
    $("phCompany").textContent = ($("hdrCompany").value||"Attendance Report").trim();
    $("phPrepared").textContent = ($("hdrPrepared").value||"â€”").trim();
    $("phApproved").textContent = ($("hdrApproved").value||"â€”").trim();
    $("phNotes").textContent = ($("hdrNotes").value||"â€”").trim();
    $("phReportTitle").textContent = tabTitle(printTab);
    $("phRange").textContent = currentRangeText();
    $("phGen").textContent = nowString();
    $("phEmp").textContent = (printTab==="emp") ? currentEmpText() : "â€”";
  }

  
  // ===== Daily print: choose columns to hide =====
  const DAILY_COLS = ["EmployeeID","Name","ShiftDate","DayName","Status","SchedStart","SchedEnd","ActualIn","ActualOut","WorkMinutes","LateMinutes","OTMinutes","Present","Absent"];
  const DAILY_COL_LABELS = {
    EmployeeID: "Ø§Ù„Ù…Ø¹Ø±Ù",
    Name: "Ø§Ù„Ø§Ø³Ù…",
    ShiftDate: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
    DayName: "Ø§Ù„ÙŠÙˆÙ…",
    Status: "Ø§Ù„Ø­Ø§Ù„Ø©",
    SchedStart: "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…",
    SchedEnd: "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…",
    ActualIn: "Ø¯Ø®ÙˆÙ„ ÙØ¹Ù„ÙŠ",
    ActualOut: "Ø§Ù†ØµØ±Ø§Ù ÙØ¹Ù„ÙŠ",
    WorkMinutes: "Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ø¹Ù…Ù„",
    LateMinutes: "Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØªØ£Ø®ÙŠØ±",
    OTMinutes: "Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ",
    Present: "Ø­Ø¶ÙˆØ±",
    Absent: "ØºÙŠØ§Ø¨"
  };
  const dailyHideState = new Set(); // column names to hide

  function renderDailyColPicker(){
    const host = $("dailyColGrid");
    if(!host) return;
    host.innerHTML = "";
    for(const col of DAILY_COLS){
      const lab = document.createElement("label");
      lab.className = "colItem";
      const ck = document.createElement("input");
      ck.type = "checkbox";
      ck.checked = dailyHideState.has(col);
      ck.addEventListener("change", ()=>{
        if(ck.checked) dailyHideState.add(col); else dailyHideState.delete(col);
        try{ localStorage.setItem("att_daily_hide", JSON.stringify(Array.from(dailyHideState))); }catch(_){}
      });
      const wrap = document.createElement("span");
      wrap.className = "colText";
      const ar = document.createElement("span");
      ar.className = "colAr";
      ar.textContent = (DAILY_COL_LABELS[col] || col);
      const en = document.createElement("span");
      en.className = "colEn";
      en.textContent = col;
      wrap.appendChild(ar); wrap.appendChild(en);
      lab.appendChild(ck);
      lab.appendChild(wrap);
      host.appendChild(lab);
    }
  }

  function setDailyMinimal(){
    // Minimal daily: keep essentials: EmployeeID, Name, ShiftDate, DayName, ActualIn, ActualOut, Status
    dailyHideState.clear();
    const keep = new Set(["EmployeeID","Name","ShiftDate","DayName","ActualIn","ActualOut","Status"]);
    for(const c of DAILY_COLS){ if(!keep.has(c)) dailyHideState.add(c); }
    renderDailyColPicker();
    try{ localStorage.setItem("att_daily_hide", JSON.stringify(Array.from(dailyHideState))); }catch(_){}
  }

  function resetDailyHide(){
    dailyHideState.clear();
    renderDailyColPicker();
    try{ localStorage.setItem("att_daily_hide", JSON.stringify([])); }catch(_){}
  }

  // Load persisted hide columns
  try{
    const saved = JSON.parse(localStorage.getItem("att_daily_hide") || "[]");
    if(Array.isArray(saved)) saved.forEach(c=> dailyHideState.add(String(c)));
  }catch(_){}

  function setPageOrientation(mode){
    const st = document.getElementById("pageStyle");
    if(!st) return;
    if(mode==="landscape"){
      st.textContent = "@page { size: A4 landscape; margin: 10mm; }";
    } else {
      st.textContent = "@page { size: A4 portrait; margin: 12mm; }";
    }
  }

  $("btnPrint").addEventListener("click", ()=>{
    const want = $("printWhat").value;
    const printTab = (want==="current") ? state.activeTab : want;
    const orientation = $("printOrientation").value;
    const fit = $("printFit").value;

    if(printTab==="emp" && $("employeeFilter").value==="ALL"){
      alert("Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©: Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù Ù…Ø­Ø¯Ø¯ Ø£ÙˆÙ„Ø§Ù‹ (Employee Report).");
      return;
    }

    setPageOrientation(orientation);
    fillPrintHeader(printTab);

    document.body.classList.add("printing");
    document.body.setAttribute("data-print-tab", printTab);
    document.body.setAttribute("data-fit", fit);

    // Apply daily hide columns only when printing Daily or Employee Report (employee daily table)
    if(printTab==="daily" || printTab==="emp"){
      const tokens = Array.from(dailyHideState).join(" ");
      if(tokens) document.body.setAttribute("data-hidecols", tokens);
      else document.body.removeAttribute("data-hidecols");
    } else {
      document.body.removeAttribute("data-hidecols");
    }

    window.print();
  });

  window.addEventListener("afterprint", ()=>{
    document.body.classList.remove("printing");
    document.body.removeAttribute("data-print-tab");
    document.body.removeAttribute("data-fit");
  });

  // ===== Theme toggle =====
  function setTheme(t){
    if(t==="light"){ document.body.setAttribute("data-theme","light"); $("btnTheme").textContent="â˜€ï¸"; }
    else { document.body.removeAttribute("data-theme"); $("btnTheme").textContent="ğŸŒ™"; }
    try{ localStorage.setItem("att_theme", t); }catch(_){}
  }
  $("btnTheme").addEventListener("click", ()=>{
    const cur = document.body.getAttribute("data-theme")==="light" ? "light" : "dark";
    setTheme(cur==="light" ? "dark" : "light");
  });
  try{
    const saved = localStorage.getItem("att_theme");
    if(saved==="light") setTheme("light");
  }catch(_){}

  

  // Daily print column picker init
  renderDailyColPicker();
  $("btnDailyMinimal")?.addEventListener("click", setDailyMinimal);
  $("btnDailyReset")?.addEventListener("click", resetDailyHide);
// ===== State =====
  let state = {
    rawCount:0, cleanCount:0,
    cleanPunches:[],
    punches:[], daily:[], summary:[],
    punchesFiltered:[], dailyFiltered:[],
    months:[], maxId:1,
    graceMin:15, rollHour:6,
    activeTab:"punches"
  };

  function applyFiltersAndRender(){
    const monthVal = $("monthFilter").value;

    state.daily = buildDailyWithAbsences(state.cleanPunches, state.rollHour, state.graceMin, monthVal, state.maxId);
    state.summary = buildSummary(state.daily);

    if(monthVal==="ALL"){
      state.punchesFiltered = state.punches;
      state.dailyFiltered = state.daily;
    } else {
      const [yyyy, mm] = monthVal.split("-").map(x=>parseInt(x,10));
      state.punchesFiltered = state.punches.filter(r=>{
        const parts = r.ShiftDate.split("/");
        return (+parts[2]===yyyy && +parts[1]===mm);
      });
      state.dailyFiltered = state.daily;
    }

    renderTable($("tblPunches"), state.punchesFiltered);
    renderTable($("tblDaily"), addTotalsRowDaily(state.dailyFiltered));
    renderTable($("tblSummary"), addTotalsRowSummary(state.summary));

    $("bestEmp").textContent = computeBest(state.summary);
    renderEmployeeReport();
  }

  // ===== Buttons =====
  $("btnProcess").addEventListener("click", ()=>{
    try{
      const rawText = $("raw").value || "";
      state.graceMin = Math.max(0, parseInt($("grace").value||"15",10));
      const dedupSeconds = Math.max(0, parseInt($("dedup").value||"60",10));
      state.rollHour = Math.max(0, Math.min(23, parseInt($("rollHour").value||"6",10)));

      const raw = parseRaw(rawText);
      state.rawCount = raw.length;
      if(raw.length===0){
        setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø£ÙŠ ØµÙ. ØªØ£ÙƒØ¯ Ù…Ù† dd/mm/yyyy ÙˆØ£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª 5 Ø£Ùˆ 6 Ø£Ø¹Ù…Ø¯Ø©.", true);
        $("kpi").style.display="none";
        renderTable($("tblPunches"), []);
        renderTable($("tblDaily"), []);
        renderTable($("tblSummary"), []);
        renderTable($("tblEmpDaily"), []);
        renderTable($("tblEmpPunches"), []);
        return;
      }

      const clean = dedupPunches(raw, dedupSeconds);
      state.cleanCount = clean.length;
      state.cleanPunches = clean;

      state.maxId = Math.max(...clean.map(p=>p.empId));
      if(!Number.isFinite(state.maxId) || state.maxId<1) state.maxId = 1;

      const nameMap = buildEmployeeNameMap(clean);
      ensureScheduleRows(nameMap, state.maxId);
      renderScheduleTable(state.maxId);

      state.punches = buildPunchRows(clean, state.rollHour);

      const tmpDailyAll = buildDailyWithAbsences(clean, state.rollHour, state.graceMin, "ALL", state.maxId);
      state.months = computeMonthsFromDaily(tmpDailyAll);

      populateMonthFilter(state.months);
      populateEmployeeFilter(state.maxId);

      applyFiltersAndRender();

      $("kpi").style.display="";
      $("kRaw").textContent=state.rawCount;
      $("kClean").textContent=state.cleanCount;
      $("kDaily").textContent=state.dailyFiltered.length;
      $("kEmp").textContent=state.maxId;

      setStatus("ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    }catch(e){
      console.error(e);
      setStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: " + (e?.message || e), true);
    }
  });

  $("btnClear").addEventListener("click", ()=>{
    $("raw").value="";
    setStatus("");
    $("kpi").style.display="none";
    state = {rawCount:0, cleanCount:0, cleanPunches:[], punches:[], daily:[], summary:[],
      punchesFiltered:[], dailyFiltered:[], months:[], maxId:1, graceMin:15, rollHour:6, activeTab:"punches"};
    renderTable($("tblPunches"), []);
    renderTable($("tblDaily"), []);
    renderTable($("tblSummary"), []);
    renderTable($("tblEmpDaily"), []);
    renderTable($("tblEmpPunches"), []);
    $("bestEmp").textContent="â€”";
    $("monthFilter").innerHTML='<option value="ALL">ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>';
    $("employeeFilter").innerHTML='<option value="ALL">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>';
    $("tblSchedule").innerHTML="";
    setActiveTab("punches");
  });

  $("monthFilter").addEventListener("change", ()=>{ if(state.cleanPunches.length) applyFiltersAndRender(); });
  $("employeeFilter").addEventListener("change", ()=>{ renderEmployeeReport(); });

  $("btnApplySchedule").addEventListener("click", ()=>{
    if(!state.cleanPunches.length){ alert("Ù‚Ù… Ø¨Ø¹Ù…Ù„ Process Ø£ÙˆÙ„Ø§Ù‹."); return; }
    if(!readScheduleFromUI(state.maxId)) return;
    applyFiltersAndRender();
    setStatus("ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ§Ù… ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…");
  });

  $("btnExportSchedule").addEventListener("click", ()=>{
    if(state.maxId<1){ alert("Ù‚Ù… Ø¨Ø¹Ù…Ù„ Process Ø£ÙˆÙ„Ø§Ù‹."); return; }
    const rows=[];
    for(let id=1; id<=state.maxId; id++){
      const s=schedule[id];
      rows.push({
        EmployeeID:id,
        Name:s.name||"",
        IsManager:s.isManager?"YES":"NO",
        WeekdayStart:s.weekdayStart, WeekdayEnd:s.weekdayEnd,
        WeekendStart:s.weekendStart, WeekendEnd:s.weekendEnd,
        Sun:s.workDays[0]?1:0, Mon:s.workDays[1]?1:0, Tue:s.workDays[2]?1:0, Wed:s.workDays[3]?1:0,
        Thu:s.workDays[4]?1:0, Fri:s.workDays[5]?1:0, Sat:s.workDays[6]?1:0
      });
    }
    downloadTSV("schedule.tsv", rows);
  });

  $("btnImportSchedule").addEventListener("click", ()=>{
    if(!state.cleanPunches.length){ alert("Ù‚Ù… Ø¨Ø¹Ù…Ù„ Process Ø£ÙˆÙ„Ø§Ù‹."); return; }
    $("importScheduleFile").click();
  });

  $("importScheduleFile").addEventListener("change", async (ev)=>{
    const file = ev.target.files?.[0];
    if(!file) return;
    const text = await file.text();
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(lines.length<2){ alert("Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±Øº."); return; }

    const header = lines[0].split("\t").map(x=>x.trim());
    const idx = (name)=> header.indexOf(name);
    const iId = idx("EmployeeID");
    if(iId<0){ alert("ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©: Ù„Ø§ ÙŠÙˆØ¬Ø¯ EmployeeID"); return; }

    const get = (cols, k)=>{ const j=idx(k); return j>=0 ? (cols[j]||"").trim() : ""; };
    let updated=0;

    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split("\t");
      const empId = parseInt((cols[iId]||"").trim(),10);
      if(!Number.isFinite(empId) || empId<1 || empId>state.maxId) continue;

      const s = schedule[empId] || defaultScheduleFor(empId);

      const name = get(cols,"Name");
      const mgr  = get(cols,"IsManager");
      const ws   = get(cols,"WeekdayStart");
      const we   = get(cols,"WeekdayEnd");
      const wEs  = get(cols,"WeekendStart");
      const wEe  = get(cols,"WeekendEnd");
      const days = [get(cols,"Sun"),get(cols,"Mon"),get(cols,"Tue"),get(cols,"Wed"),get(cols,"Thu"),get(cols,"Fri"),get(cols,"Sat")]
        .map(x => String(x).trim()==="1" || String(x).trim().toUpperCase()==="TRUE" || String(x).trim().toUpperCase()==="YES");

      if(name) s.name=name;
      if(mgr) s.isManager = (mgr.toUpperCase()==="YES" || mgr==="1" || mgr.toUpperCase()==="TRUE");
      if(hhmmOk(ws)) s.weekdayStart=ws;
      if(hhmmOk(we)) s.weekdayEnd=we;
      if(hhmmOk(wEs)) s.weekendStart=wEs;
      if(hhmmOk(wEe)) s.weekendEnd=wEe;
      if(days.length===7) s.workDays=days;

      schedule[empId]=s;
      updated++;
    }

    renderScheduleTable(state.maxId);
    applyFiltersAndRender();
    alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØ­Ø¯ÙŠØ« ${updated} Ù…ÙˆØ¸Ù.`);
    ev.target.value="";
  });

  // exports
  $("btnExportPunches").addEventListener("click", ()=>{
    if(!state.punchesFiltered.length){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª."); return; }
    const m=$("monthFilter").value;
    downloadTSV(`punches_${m==="ALL"?"all":m}.tsv`, state.punchesFiltered);
  });
  $("btnExportDaily").addEventListener("click", ()=>{
    if(!state.dailyFiltered.length){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª."); return; }
    const m=$("monthFilter").value;
    downloadTSV(`daily_${m==="ALL"?"all":m}.tsv`, addTotalsRowDaily(state.dailyFiltered));
  });
  $("btnExportSummary").addEventListener("click", ()=>{
    if(!state.summary.length){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª."); return; }
    const m=$("monthFilter").value;
    downloadTSV(`summary_${m==="ALL"?"all":m}.tsv`, addTotalsRowSummary(state.summary));
  });

  
  $("btnXlsxSummary").addEventListener("click", ()=> exportDatasetXLSX("summary"));
  $("btnXlsxDaily").addEventListener("click", ()=> exportDatasetXLSX("daily"));
  $("btnXlsxPunches").addEventListener("click", ()=> exportDatasetXLSX("punches"));
  $("btnXlsxEmployee").addEventListener("click", ()=> exportDatasetXLSX("employee"));
// Init
  renderTable($("tblPunches"), []);
  renderTable($("tblDaily"), []);
  renderTable($("tblSummary"), []);
  renderTable($("tblEmpDaily"), []);
  renderTable($("tblEmpPunches"), []);
  setActiveTab("punches");
})();

</script>
</body>
</html>
